<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.340">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>LMM/MLM - 8: Model Building</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>
<script>
function toggle_visibility(id1, id2) {
var e = document.getElementById(id1);
var f = document.getElementById(id2);
e.style.display = ((e.style.display!='none') ? 'none' : 'block');
if(f.classList.contains('jk-circle-right')) {
    f.classList.add('jk-circle-down')
    f.classList.remove('jk-circle-right')
} else {
    f.classList.add('jk-circle-right')
    f.classList.remove('jk-circle-down')
}
}
</script>

<!---<script src="https://kit.fontawesome.com/120b08a6f5.js" crossorigin="anonymous"></script>-->
<link href="site_libs/panelset-0.3.0/panelset.css" rel="stylesheet">
<script src="site_libs/panelset-0.3.0/panelset.js"></script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
      <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./08_modelbuilding.html">8: Model Building</a></li></ol></nav>
      <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
      </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">LMM/MLM</a> 
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01_clustered.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">1: Clustered Data</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02_lmm.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">2: The Multi-level/Mixed Effect Model</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03_inference.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">3: Inference for MLM</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./04_log.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">4: Example: Logistic MLM</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./05_long.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">5: Example: Longitudinal MLM</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./06_poly.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">6: Polynomial Growth in MLM</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./07_ranef.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">7: Random Effect Structures</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./08_modelbuilding.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">8: Model Building</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./09_assump.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">9: MLM Assumptions</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./10_centering.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">10: Centering</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./11_writing.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">11: Reporting on analyses with MLM</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="false">
 <span class="menu-text">Additional Docs</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./00_lm_assumpt.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">LM Troubleshooting</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./lvp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Likelihood vs Probability</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./00_datasets.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Practice Datasets TODO arrange by methods</span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#model-building-strategies" id="toc-model-building-strategies" class="nav-link active" data-scroll-target="#model-building-strategies">Model Building Strategies</a>
  <ul class="collapse">
  <li><a href="#maximal-model" id="toc-maximal-model" class="nav-link" data-scroll-target="#maximal-model">Maximal Model</a></li>
  <li><a href="#non-convergence" id="toc-non-convergence" class="nav-link" data-scroll-target="#non-convergence">Non-Convergence</a></li>
  <li><a href="#singular-fits" id="toc-singular-fits" class="nav-link" data-scroll-target="#singular-fits">Singular Fits</a></li>
  </ul></li>
  <li><a href="#simplifying-random-effect-structures" id="toc-simplifying-random-effect-structures" class="nav-link" data-scroll-target="#simplifying-random-effect-structures">Simplifying Random Effect Structures</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">8: Model Building</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<div class="lo">
<p>This reading:</p>
<ul>
<li><p>the ‘maximal’ model</p></li>
<li><p>non-convergence and overfitted models</p></li>
<li><p>strategies for simplifying models</p></li>
</ul>
</div>
<section id="model-building-strategies" class="level1">
<h1>Model Building Strategies</h1>
<p>Random effect structures can get pretty complicated quite quickly. In confirmatory analyses, very often the random effects part is not of specific interest to us, but we wish to estimate random effects in order to more accurately partition up the variance in our outcome variable and provide better estimates of fixed effects (the bit we <em>are</em> interested in).</p>
<p>This process becomes a fine balancing act between choosing a random effect structure that most accurately reflects the underlying process we believe generated the data, and one that we are actually able to fit to our data without too much simplification.</p>
<p>One common approach to fitting multilevel models is to first fit the maximal model (the most complex model <em>that the study design allows</em>, in which we include random effects for everything that makes <em>theoretical</em> sense as varying by our groupings). Because this “maximal model” will often not converge or be too complext to be supported by our data, we then progress to simplifying our random effect structure until we obtain a converging model.</p>
<div class="sticky">
<p><strong>Fully Maximal Model</strong></p>
<p>The “maximal model” is the model with all possible<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a> random effects included.</p>
</div>
<section id="maximal-model" class="level2">
<h2 class="anchored" data-anchor-id="maximal-model">Maximal Model</h2>
<p>Typically for many research designs, the following steps will keep you mostly on track to finding the maximal model.</p>
<p>Start by thinking of the model structure in terms of these components:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">lmer</span>(outcome <span class="sc">~</span> fixed effects <span class="sc">+</span> </span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>       (random effects <span class="sc">|</span> grouping structure), </span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>     <span class="at">data =</span> ...)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ol type="1">
<li><p>Specify the <code>outcome ~ fixed effects</code> bit first.</p>
<ul>
<li>The outcome variable should be clear: it is the variable we are wishing to explain/predict.</li>
<li>The fixed effects are the things we want to use to explain/predict variation in the outcome variable. These will often be the things that are of specific inferential interest along with potential confounders and other covariates. Just like the simple linear model.</li>
</ul></li>
<li><p>If there is a grouping structure to your data, and those groups (preferably n&gt;7 or 8) are perceived as a random sample of a wider population (the specific groups aren’t interesting to you), then consider including random intercepts (and possibly random slopes of predictors) for those groups <code>(1 + ... | grouping)</code>.</p></li>
<li><p>If there are multiple different grouping structures, is one nested within another? If so, we can specify this as <code>(1 | higher_grouping ) + (1 |  lower_grouping:higher_grouping)</code>.<br>
If the grouping structures are <strong>not</strong> nested, we can specify them as crossed: <code>(1 | grouping1) + (1 | grouping2)</code>.</p></li>
<li><p>If any of the predictors in the fixed effects vary <strong>within</strong> the groups, it may be possible to also include them as random effects. For predictors that instead vary <strong>between</strong> groups, it rarely makes sense to include these as by-group random effects. For example, if we had a model with <code>lmer(score ~ genetic_status + (1 + genetic_status | patient))</code> then we would be trying to model a process where “the effect of genetic_status on scores is different for each patient”. But if you consider an individual patient, their genetic status never changes. For patient <span class="math inline">\(i\)</span>, what is “the effect of genetic status on score”? It’s undefined. This is because genetic status only varies <em>between</em> patients.</p>
<ul>
<li>as a general rule, don’t specify random effects that are not also specified as fixed effects (an exception could be specifically for model comparison, to isolate the contribution of the fixed effect).<br>
</li>
<li>Sometimes, things can vary within one grouping, but not within another. E.g., for a design in which patients are nested within hospitals <code>(1 | hospital) + (1 | patient:hospital)</code>, genetic_status varies <em>between</em> patients, but <em>within</em> hospitals. Therefore we could theoretically fit a random effect of <code>(1 + genetic_status | hospital)</code>, but <strong>not</strong> one for <code>(1 + genetic_status | patient:hospital)</code>.</li>
</ul></li>
</ol>
</section>
<section id="non-convergence" class="level2">
<h2 class="anchored" data-anchor-id="non-convergence">Non-Convergence</h2>
<p>Oftentimes, models with more complex random effect structures will not converge because there are so many parameters, and not enough variability in the data, meaning that there are more places for the model estimation to go wrong. Remember that we fit these models with maximum likelihood estimation (MLE), a process that involves taking a guess at the model parameters that result in the greatest probability of the observed data, and step-by-step improving those guesses until we think we’re at the most likely set of parameters - until the model ‘converges’. Sometimes, however, MLE can sometimes get stuck, resulting in ‘non-convergence’.</p>
<p>There are many possible reasons for non-convergence, and it does <em>not necessarily</em> mean the fit is incorrect. However it is <strong>is cause for concern</strong>, and should be addressed before using the model, else you may end up reporting inferences which do not hold. There are lots of different things which we can try which <em>might</em> help our model to converge. A select few are detailed below:</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-1-contents" aria-controls="callout-1" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Things we can try
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-1" class="callout-1-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="imp">
<p><strong>most likely solutions:</strong></p>
<ul>
<li><p>double-check the model specification and the data</p></li>
<li><p>Consider simplifying your model (more on this below)</p></li>
</ul>
</div>
<ul>
<li><p>Center and scale continuous predictor variables (e.g.&nbsp;with <code>scale</code>)</p></li>
<li><p>Change the optimization method (for example, here we change it to <code>bobyqa</code>):<br>
<code>lmer(..., control = lmerControl(optimizer="bobyqa"))</code><br>
<code>glmer(..., control = glmerControl(optimizer="bobyqa"))</code></p></li>
<li><p>Use <code>allFit()</code> to try the fit with all available optimizers. This will of course be slow, but is considered ‘the gold standard’; <em>“if all optimizers converge to values that are practically equivalent, then we would consider the convergence warnings to be false positives.”</em><br>
<code>allopts &lt;- allFit(model)</code><br>
<code>summary(allopts)</code></p></li>
</ul>
<div class="columns">
<div class="column" style="width:50%;">
<ul>
<li>Fine-tune an optimizer. Using the optCtrl argument to [g]lmerControl (see <code>?convergence</code> for details), we can have a lot of control over the optimizer. Recall that the optimizer is a method of iteratively assessing a set of parameters to maximise the probability of seeing the observed data<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a>. We can change things such as the number of steps the algorithm keeps trying for, and the thresholds at which the algorithm stops (<a href="#fig-tolerance">Figure&nbsp;1</a>).</li>
</ul>
</div><div class="column" style="width:50%;">
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div id="fig-tolerance" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="images/tolerance.png" class="img-fluid figure-img" style="width:80.0%"></p>
<figcaption class="figure-caption">Figure&nbsp;1: An optimizer will stop after a certain number of iterations, or when it meets a tolerance threshold</figcaption>
</figure>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</section>
<section id="singular-fits" class="level2">
<h2 class="anchored" data-anchor-id="singular-fits">Singular Fits</h2>
<p>As well as convergence warnings, you may have noticed that some of our models over the last few weeks have been giving a warning message:</p>
<p style="color:red">
boundary (singular) fit: see ?isSingular
</p>
<p>Up to now, we’ve been largely ignoring these messages, but we should really have been addressing them in some way. ‘Singular fit’ warnings indicate that our model is likely to be ‘overfitted’ - that is, the random effects structure which we have specified is <strong>too complex to be supported by the data</strong>.</p>
<p>For simple random effect structures (i.e.&nbsp;a random intercept + a random slope), we can often see this issue reflected in the variance components of the random effect, when variances get estimated at (or very close to) zero, and/or when correlations get estimated at (or very close to) 1 or -1 (<a href="#fig-singular">Figure&nbsp;2</a>). With more complex structures it is not always so easily visible, but we can do a double check for this issue using the handy <code>isSingular(model)</code> function - if it returns <code>TRUE</code> then it indicates our model might be overfitted.</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div id="fig-singular" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="images/varcorrsingular.png" width="550" height="300" class="figure-img"></p>
<figcaption class="figure-caption">Figure&nbsp;2: In simple random effect structures we can often easily see issues of overfitting as they are reflected in variances being estimated as 0 and/or correlations being estimated as perfect correlations of 1 or -1</figcaption>
</figure>
</div>
</div>
</div>
<p>What do we do in these cases? Simplify, simplify, simplify!</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-2-contents" aria-controls="callout-2" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Scales can matter!
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-2" class="callout-2-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<!-- Suppose that people tend to be between 140cm and 190cm tall and (for some reason) we decide to measure their height in kilometers. In these units, people tend to be between 0.00140km and 0.00190km tall. If we calculate the variance of height-in-km, we're going to get a very small number.  -->
<p>The scale of our predictors can sometimes play a part here. If we were fitting a model of <code>shoe_size ~ height</code>, then the estimated coefficient is going to depend on how we measure height. If we measure it in millimeters, then we’ll probably have a very small coefficient (people’s shoe size will only change by a tiny amount for every 1mm height they gain), but if we measure height in kilometers, then we’ll have a very big coefficient (“grow an extra kilometer in height, and your shoe size will increase 10000 sizes”!!).</p>
<p>In the multilevel model, we’re estimating the variances in these relationships across a set of clusters. If the coefficient is in millimeters, then the variance is in millimeters too, and so the number will be quite small. If it’s in kilometers, the coefficient is in units 100,000 times bigger, and so is the variance.</p>
<p>Scaling predictors doesn’t change the relationship being studied, but it does change the numeric values we are asking our relationship to be presented in. As the estimation of multilevel models can get into difficulty when variances are too close to zero, you may occasionally receive messages such as those below.</p>
<p>Pay attention to them, and check your variables. If some are on very different scales, then consider trying to rescale them to something that is still meaningful for you.</p>
<p style="color:red">
Warning messages:<br> 1: Some predictor variables are on very different scales:<br> consider rescaling
</p>
<p style="color:red">
Warning messages:<br> 1: In checkConv(attr(opt, “derivs”), opt$par, ctrl = control$checkConv, :<br>Model is nearly unidentifiable: large eigenvalue ratio<br> - Rescale variables?
</p>
</div>
</div>
</div>
</section>
</section>
<section id="simplifying-random-effect-structures" class="level1">
<h1>Simplifying Random Effect Structures</h1>
<p>There is no <em>right</em> way to simplify random effect structures - it’s about what kind of simplifications we are willing to make (which is a subjective decision). Key to the process of simplifying your random effects is to <strong>think about how the data are generated</strong>, and to <strong>keep in mind your research question</strong>. Asking yourself things such as “do we have good reason to assume subjects might vary over time, or to assume that they will have different starting points (i.e., different intercepts)?” can help you in reasoning through the problem.</p>
<p>Examining the variance components of a non-converging model can also help to point towards problematic terms. Be on the look out for random effects with little variance, or with near perfect correlation. When variance estimates are very low for a specific random effect term, this indicates that the model is not estimating this parameter to differ much between the levels of your grouping variable. It might, given the study design, be perfectly acceptable to remove this or simply include it as a fixed effect.</p>
<p>Below are various considerations to keep in mind, along with some practical strategies</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-3-contents" aria-controls="callout-3" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Reasons to Include Random Slopes
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-3" class="callout-3-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p><em>random slopes of predictors of interest</em><br>
If we want to make inferences about a fixed effect <code>x</code> that is measured <strong>within</strong> groups, then failing to include a corresponding random slope of <code>x</code> will increase the chance of making a type I error (we’ll be more likely to conclude there <em>is</em> an effect even if in reality there is no effect). Intuitively - if we let each group be different, then our estimate of ‘the average group’ becomes less certain.</p>
<p><em>random slopes of covariates</em><br>
If a fixed effect <code>c</code> that is measured within groups is not of inferential interest but is instead included in the model as a covariate, then it is less crucial to include a corresponding random slope of <code>c</code>, because the fixed effect is sufficient. However, including random slopes of <code>c</code> can improve the precision of the effects that we <em>are</em> interested in, depending on the level of multicollinearity of those variables with <code>c</code>.</p>
</div>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-4-contents" aria-controls="callout-4" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
‘More Complex’ Random Effect Terms
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-4" class="callout-4-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Complex terms like interactions (e.g.&nbsp;<code>(1 + x1 * x2 | group)</code> are often causes of non-convergence or overfitting as they require more data to estimate group-level variability, and the interaction terms is often highly correlated with the individual effects. Prior to removing one of the terms completely, this can be simplified to <code>(1 + x1 + x2 | group)</code>.</p>
</div>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-5-contents" aria-controls="callout-5" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Random Effect Correlations
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-5" class="callout-5-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>The ‘random effects’ part of multilevel models includes not just variances of group-level effects, but also the correlations between different terms. The part of the output of the <code>VarCorr()</code> function that comes under “Corr” is a correlation matrix (i.e., a square symmetric matrix with the same columns as rows, and 1s on the diagonal, see <a href="#fig-varcorr">Figure&nbsp;3</a>).</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div id="fig-varcorr" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="images/varcorr.png" width="519" class="figure-img"></p>
<figcaption class="figure-caption">Figure&nbsp;3: The VarCorr() function shows the same information as in the top part of the summary() output - the variances/std.deviations of each random effect term, and the lower half of the correlation matrix of these terms (the upper half filled in here for illustration)</figcaption>
</figure>
</div>
</div>
</div>
<p>So what exactly do these correlations represent? Recall that the ‘random effects’ parts of our models is the estimation of how groups deviate around the fixed effects.</p>
<p>In estimating a random effect structure with intercepts and slopes, we are estimating these random effects as <em>jointly</em> distibuted as a ‘multivariate normal distribution’.</p>
<p><span class="math display">\[
\begin{bmatrix} \zeta_{0i} \\ \zeta_{1i} \end{bmatrix}
\sim N
\left(
    \begin{bmatrix} 0 \\ 0 \end{bmatrix},
    \begin{bmatrix}
        \sigma_0 &amp; \rho_{01} \\
        \rho_{01} &amp; \sigma_1
    \end{bmatrix}
\right)
\]</span></p>
<p>In essence, this means we are estimating means, variances (or standard deviations), and covariances (or correlations). The means of random effects are by definition 0, and we have already seen plenty about the variances thus far when talking about random effects. The correlations are the estimated relationship between different terms - e.g., do groups with higher intercepts tend to have higher/lower slopes?</p>
<p>It often helps to think about what these would be like when the correlations are perfect (i.e.&nbsp;1 or -1). In <a href="#fig-perfcor">Figure&nbsp;4</a>, we can see that in the Left hand panel, the higher a group starts, the more upwards the slope (and vice versa). In the Right hand panel the reverse is true - groups with higher intercepts have more downwards slopes. In the middle panel, where the correlation is 0, there’s no systematic pattern between where the lines start and their angle across x.</p>
<p>We can see a visualisation of the distributions below each plot, with each point representing a group in the model. For perfect correlations, plots of group-intercepts against group-slopes will fall along a perfectly straight line. When there is no correlation these are scattered randomly, and as the estimated correlation gets stronger, the circular density in the bottom-middle plot of <a href="#fig-perfcor">Figure&nbsp;4</a> becomes more elliptical.</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div id="fig-perfcor" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="08_modelbuilding_files/figure-html/fig-perfcor-1.png" class="img-fluid figure-img" style="width:100.0%"></p>
<figcaption class="figure-caption">Figure&nbsp;4: Group specific lines when intercepts and slopes are perfectly positively (Left) and negatively (Right) correlated</figcaption>
</figure>
</div>
</div>
</div>
<p>We can choose (if we so wish) to <strong>not</strong> estimate the correlations between random effects. This choice equates to fixing this correlation in our model be 0. We do this by using two vertical lines <code>||</code> instead of one. By removing correlations between random effects we are reducing the number of parameters than are being estimated - our model becomes simpler! However, it is worth noting that this decision should be thought about carefully - does it make sense to constrain a given correlation to be zero?</p>
<table class="table">
<colgroup>
<col style="width: 36%">
<col style="width: 36%">
<col style="width: 26%">
</colgroup>
<thead>
<tr class="header">
<th>lme4 syntax</th>
<th>description</th>
<th>equation</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>... + (1 | g)</code></td>
<td>random intercepts only</td>
<td><span class="math display">\[\zeta_{0i} \sim N (0, \sigma_0)\]</span></td>
</tr>
<tr class="even">
<td><code>... + (0 + x | g)</code></td>
<td>random slopes only</td>
<td><span class="math display">\[\zeta_{1i} \sim N (0, \sigma_1)\]</span></td>
</tr>
<tr class="odd">
<td><code>... + (1 + x || g)</code></td>
<td>random intercepts and slopes, zero covariance</td>
<td><span class="math display">\[\begin{bmatrix} \zeta_{0i}\\ \zeta_{1i} \end{bmatrix} \sim N \left( \begin{bmatrix} 0 \\ 0 \end{bmatrix}, \begin{bmatrix} \sigma_0 &amp; 0 \\ 0 &amp; \sigma_1 \end{bmatrix} \right)\]</span></td>
</tr>
<tr class="even">
<td><code>... + (1 + x | g)</code></td>
<td>random intercepts and slopes</td>
<td><span class="math display">\[\begin{bmatrix} \zeta_{0i}\\ \zeta_{1i} \end{bmatrix} \sim N \left( \begin{bmatrix} 0 \\ 0 \end{bmatrix}, \begin{bmatrix} \sigma_0 &amp; \rho_{01} \\ \rho_{01} &amp; \sigma_1 \end{bmatrix} \right)\]</span></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-7-contents" aria-controls="callout-7" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Categorical Random Effects on the RHS
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-7" class="callout-7-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>When we have a categorical random effect (i.e.&nbsp;where the <code>x</code> in <code>(1 + x | g)</code> is a categorical variable), then model estimation can often get tricky, because “the effect of x” for a categorical variable with <span class="math inline">\(k\)</span> levels is identified via <span class="math inline">\(k-1\)</span> parameters, meaning we have a lot of variances and covariances to estimate when we include <code>x|g</code>.</p>
<div class="columns">
<div class="column" style="width:45%;">
<p>When <code>x</code> is numeric:</p>
<pre><code>Groups   Name        Std.Dev. Corr  
g        (Intercept) ...        
         x           ...      ...
Residual             ...     </code></pre>
</div><div class="column" style="width:10%;">

</div><div class="column" style="width:45%;">
<p>When <code>x</code> is categorical with <span class="math inline">\(k\)</span> levels:</p>
<pre><code>Groups   Name        Std.Dev. Corr  
g        (Intercept) ...        
         xlevel2     ...      ...
         xlevel3     ...      ...     ...
         ...         ...      ...     ...     ...
         xlevelk     ...      ...     ...     ...   ...
Residual             ...     </code></pre>
</div>
</div>
<p>One neat trick is to consider moving the categorical predictor the right hand side, nesting it within the groups:<br>
<code>(1 + x | g)</code><br>
becomes<br>
<code>(1 | g) + (1 | g:x)</code></p>
<p>Remember that the symbol <code>:</code> in <code>g:x</code> is used to refer to the combination of <code>g</code> and <code>x</code>, and is just the same as how we specify nested random effects.</p>
<div class="cell" data-layout-align="center">
<div class="cell-output cell-output-stdout">
<pre><code>      g        x     g:x
1    p1        a    p1.a
2    p1        a    p1.a
3    p1        b    p1.b
4   ...      ...     ...
5    p2        a    p2.a
6    p2        b    p2.b
7   ...      ...     ...</code></pre>
</div>
</div>
<p>It’s a bit weird to think about it, but these two formulations of the random effects can kind of represent the same idea:</p>
<ul>
<li><strong>A:</strong> <code>(1 + x | g)</code>: each group of <code>g</code> can have a different intercept and a different effect of <code>x</code><br>
</li>
<li><strong>B:</strong> <code>(1 | g) + (1 | g:x)</code>: each group of <code>g</code> can have a different intercept, and each level of <code>x</code> within each <code>g</code> can have a different intercept.</li>
</ul>
<p>Both of these allow the outcome <code>y</code> to be different across <code>x</code>, and these differences be different for each <code>g</code> (i.e.&nbsp;both of them result in <code>y</code> being different for each <code>g:x</code> value). Formulation <strong>A</strong> above does this explicitly by estimating the group level variance of the <code>y~x</code> effect (“the effect of <code>x</code> on <code>y</code> is different for each <code>g</code>”). The second formulation <strong>B</strong> estimates the variance of <code>y</code> between groups <code>g</code>, and <em>also</em> the variance of <code>y</code> between ‘levels of <code>x</code> within groups <code>g</code>’. So we’re saying that “<code>y</code> is different for each <code>g</code>, and <code>y</code> is different for each <code>x</code>-within-<code>g</code>.</p>
<p>So both of these achieve more or less the same thing, but in the second formulation by capturing this as intercept variation between levels of <code>g:x</code>, we don’t have to worry about lots of covariances:</p>
<div class="columns">
<div class="column" style="width:45%;">
<p><code>(1 + x | g)</code></p>
<pre><code>Groups   Name        Std.Dev. Corr  
g        (Intercept) ...        
         xlevel2     ...      ...
         xlevel3     ...      ...     ...
         ...         ...      ...     ...     ...
         xlevelk     ...      ...     ...     ...   ...
Residual             ...     </code></pre>
</div><div class="column" style="width:10%;">

</div><div class="column" style="width:45%;">
<p><code>(1 | g) + (1 | g:x)</code></p>
<pre><code>Groups   Name        Std.Dev. 
g        (Intercept) ...        
g.x      (Intercept) ...        
Residual             ...     </code></pre>
</div>
</div>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-6-contents" aria-controls="callout-6" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
optional: attempted visual explanation
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-6" class="callout-6-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>I typically think of formulation <strong>A</strong> as a panel of <code>y~x</code> plots for each group, where the slopes can be different for each panel.</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="08_modelbuilding_files/figure-html/unnamed-chunk-9-1.png" style="width:80.0%" height="200" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>For the second formulation <strong>B</strong>, I think of this in terms of nested random intercepts - there is a distribution of group averages (the grey distribution below), and within groups there is a distribution of x-level averages (the coloured distributions below).</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="08_modelbuilding_files/figure-html/unnamed-chunk-10-1.png" style="width:80.0%" height="200" class="figure-img"></p>
</figure>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<p>TODO</p>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-8-contents" aria-controls="callout-8" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
optional: PCA on the random effect variance-covariance matrix
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-8" class="callout-8-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>We’re probably yet to hear about “PCA” (principal component analysis), but the very high-level view is that it aims to simplify a set of variables by identifying the most important patterns or “components” (allowing us drop less important ways in which people vary). For instance, if a survey asked 10 questions, 5 of which were about physical health, and 5 which were about mental health, then the 5 physical health questions would likely be correlated with one another, and the 5 mental health questions would likely be correlated with one another. PCA might tell us something like “given this set of correlations, 2 ‘dimensions’ can explain most of the variability that we see”.</p>
<p>The benefit for us in this context is that we have a correlation matrix in our random effects from a maximal model, and we can use PCA to ask “how many ‘dimensions’ capture most of this variation?”</p>
<p>In the <strong>lme4</strong> package the <code>rePCA()</code> function can do this when we give it an <code>lmer()</code> model.</p>
<p>TODO example</p>
<ol type="1">
<li>fit maximal</li>
<li>summary(rePCA(model))</li>
<li>fit ZCP</li>
</ol>
</div>
</div>
</div>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-9-contents" aria-controls="callout-9" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
optional: data-driven approaches
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-9" class="callout-9-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>library(buildmer) buildmer(formula,buildmerControl=buildmerControl(direction=c(“order”,“backward”), crit=“LRT”))</p>
</div>
</div>
</div>


</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>this doesn’t mean simply including <em>every</em> predictor in the fixed effects also in the random effects part. ‘possible’ refers to ‘possible given the study design’<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p>instead of maximising the likelihood, more often (for practical reasons) our algorithms try to minimise <span class="math inline">\(-2 \times\)</span> the log-likelihood<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center">© Copyright 2019-2024 <a href="https://www.ed.ac.uk/">The University of Edinburgh</a>. Site licensed under the <a href="https://www.gnu.org/licenses/agpl-3.0.en.html">GNU AGPLv3</a> license.</div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>



</body></html>